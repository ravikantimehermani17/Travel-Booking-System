<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Flights - TravelEase</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

:root {
  --primary: #2563eb;
  --primary-light: #3b82f6;
  --primary-dark: #1d4ed8;
  --secondary: #64748b;
  --accent: #f59e0b;
  --accent-light: #fbbf24;
  --accent-dark: #d97706;
  --gray-50: #f8fafc;
  --gray-100: #f1f5f9;
  --gray-200: #e2e8f0;
  --gray-300: #cbd5e1;
  --gray-400: #94a3b8;
  --gray-500: #64748b;
  --gray-600: #475569;
  --gray-700: #334155;
  --gray-800: #1e293b;
  --gray-900: #0f172a;
  --success: #10b981;
  --warning: #f59e0b;
  --danger: #ef4444;
  --info: #3b82f6;
  --text-primary: #0f172a;
  --text-secondary: #475569;
  --text-muted: #64748b;
  --text-white: #ffffff;
  --bg-primary: #ffffff;
  --bg-secondary: #f8fafc;
  --bg-muted: #f1f5f9;
  --border-light: #e2e8f0;
  --border-medium: #cbd5e1;
  --border-dark: #94a3b8;
  --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
  --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
  --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
  --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
  --radius-sm: 0.375rem;
  --radius-md: 0.5rem;
  --radius-lg: 0.75rem;
  --radius-xl: 1rem;
  --radius-2xl: 1.5rem;
  --font-size-xs: 0.75rem;
  --font-size-sm: 0.875rem;
  --font-size-base: 1rem;
  --font-size-lg: 1.125rem;
  --font-size-xl: 1.25rem;
  --font-size-2xl: 1.5rem;
  --font-size-3xl: 1.875rem;
  --font-size-4xl: 2.25rem;
  --font-size-5xl: 3rem;
  --font-size-6xl: 3.75rem;
}

* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: 'Inter', 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif; font-size: var(--font-size-base); line-height: 1.6; color: var(--text-primary); background: var(--bg-secondary); -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
a { color: inherit; text-decoration: none; transition: all 0.2s ease; }
button { cursor: pointer; border: none; font-family: inherit; font-size: inherit; transition: all 0.2s ease; }
input, textarea, select { font-family: inherit; font-size: inherit; transition: all 0.2s ease; }
.btn { display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; padding: 0.75rem 1.5rem; font-size: var(--font-size-sm); font-weight: 500; border-radius: var(--radius-lg); border: 1px solid transparent; cursor: pointer; transition: all 0.2s ease; text-decoration: none; white-space: nowrap; }
.btn:disabled { opacity: 0.6; cursor: not-allowed; }
.btn-primary { background: var(--primary); color: var(--text-white); box-shadow: var(--shadow-sm); }
.btn-primary:hover:not(:disabled) { background: var(--primary-dark); box-shadow: var(--shadow-md); transform: translateY(-1px); }
.btn-lg { padding: 1rem 2rem; font-size: var(--font-size-lg); border-radius: var(--radius-xl); }
.btn-sm { padding: 0.5rem 1rem; font-size: var(--font-size-xs); }
.btn-accent { background: var(--accent); color: var(--text-white); }
.btn-accent:hover:not(:disabled) { background: var(--accent-dark); }

.page-fade-in { animation: fadeIn 0.6s ease-out; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

/* Dashboard styles from dashboard.css */
.dashboard-wrapper {
  min-height: 100vh;
  background: var(--bg-secondary);
  display: grid;
  grid-template-areas:
    "header header"
    "sidebar main";
  grid-template-rows: auto 1fr;
  grid-template-columns: 280px 1fr;
}

.dashboard-header {
  grid-area: header;
  background: var(--bg-primary);
  border-bottom: 1px solid var(--border-light);
  padding: 0 1.5rem;
  height: 70px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  position: sticky;
  top: 0;
  z-index: 100;
  box-shadow: var(--shadow-sm);
}

.header-left {
  display: flex;
  align-items: center;
  gap: 1rem;
}

.sidebar-toggle {
  display: none;
  background: none;
  border: none;
  font-size: 1.25rem;
  color: var(--text-secondary);
  cursor: pointer;
  padding: 0.5rem;
  border-radius: var(--radius-md);
  transition: all 0.2s ease;
}

.sidebar-toggle:hover {
  background: var(--gray-100);
  color: var(--primary);
}

.brand {
  display: flex;
  align-items: center;
  gap: 0.75rem;
}

.brand-logo {
  width: 32px;
  height: 32px;
  border-radius: 50%;
}

.brand-name {
  font-size: var(--font-size-lg);
  font-weight: 700;
  color: var(--primary);
}

.header-right {
  display: flex;
  align-items: center;
  gap: 1.5rem;
}

.search-bar {
  position: relative;
  display: flex;
  align-items: center;
}

.search-bar i {
  position: absolute;
  left: 1rem;
  color: var(--text-muted);
  z-index: 1;
}

.search-bar input {
  width: 320px;
  padding: 0.75rem 1rem 0.75rem 2.5rem;
  border: 1px solid var(--border-light);
  border-radius: var(--radius-lg);
  background: var(--bg-secondary);
  font-size: var(--font-size-sm);
  transition: all 0.2s ease;
}

.search-bar input:focus {
  outline: none;
  border-color: var(--primary);
  background: var(--bg-primary);
  box-shadow: 0 0 0 3px rgb(37 99 235 / 0.1);
}

.header-actions {
  display: flex;
  align-items: center;
  gap: 1rem;
}

.icon-btn {
  position: relative;
  background: none;
  border: none;
  color: var(--text-muted);
  font-size: 1.25rem;
  cursor: pointer;
  padding: 0.75rem;
  border-radius: var(--radius-lg);
  transition: all 0.2s ease;
}

.icon-btn:hover {
  background: var(--gray-100);
  color: var(--text-primary);
}

.notification-badge {
  position: absolute;
  top: 0.5rem;
  right: 0.5rem;
  background: var(--danger);
  color: var(--text-white);
  font-size: var(--font-size-xs);
  font-weight: 600;
  width: 18px;
  height: 18px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
}

.user-menu {
  position: relative;
}

.user-menu-trigger {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  background: none;
  border: none;
  padding: 0.5rem;
  border-radius: var(--radius-lg);
  cursor: pointer;
  transition: all 0.2s ease;
}

.user-menu-trigger:hover {
  background: var(--gray-100);
}

.user-avatar {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  object-fit: cover;
}

.user-dropdown {
  position: absolute;
  top: calc(100% + 0.5rem);
  right: 0;
  background: var(--bg-primary);
  border: 1px solid var(--border-light);
  border-radius: var(--radius-lg);
  box-shadow: var(--shadow-lg);
  min-width: 200px;
  padding: 0.5rem;
  opacity: 0;
  visibility: hidden;
  transform: translateY(-10px);
  transition: all 0.2s ease;
  z-index: 1000;
}

.user-menu:hover .user-dropdown {
  opacity: 1;
  visibility: visible;
  transform: translateY(0);
}

.dropdown-item {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  width: 100%;
  padding: 0.75rem 1rem;
  background: none;
  border: none;
  color: var(--text-secondary);
  text-decoration: none;
  border-radius: var(--radius-md);
  font-size: var(--font-size-sm);
  cursor: pointer;
  transition: all 0.2s ease;
}

.dropdown-item:hover {
  background: var(--gray-100);
  color: var(--text-primary);
}

.dropdown-divider {
  height: 1px;
  background: var(--border-light);
  margin: 0.5rem 0;
}

.logout-btn {
  color: var(--danger);
}

.logout-btn:hover {
  background: rgba(239, 68, 68, 0.1);
}

.sidebar {
  grid-area: sidebar;
  background: var(--bg-primary);
  border-right: 1px solid var(--border-light);
  height: calc(100vh - 70px);
  overflow-y: auto;
  position: sticky;
  top: 70px;
}

.sidebar-content {
  padding: 1.5rem 1rem;
}

.sidebar-user {
  display: flex;
  align-items: center;
  gap: 1rem;
  padding: 1rem;
  background: var(--gray-50);
  border-radius: var(--radius-xl);
  margin-bottom: 2rem;
}

.user-avatar-large {
  position: relative;
}

.user-avatar-large img {
  width: 48px;
  height: 48px;
  border-radius: 50%;
  object-fit: cover;
}

.status-indicator {
  position: absolute;
  bottom: 2px;
  right: 2px;
  width: 12px;
  height: 12px;
  border-radius: 50%;
  border: 2px solid var(--bg-primary);
}

.status-indicator.online {
  background: var(--success);
}

.user-info h3 {
  font-size: var(--font-size-base);
  font-weight: 600;
  color: var(--text-primary);
  margin-bottom: 0.25rem;
}

.user-status {
  font-size: var(--font-size-xs);
  color: var(--accent);
  font-weight: 500;
  margin: 0;
}

.sidebar-nav {
  display: flex;
  flex-direction: column;
  gap: 1.5rem;
}

.nav-section-title {
  font-size: var(--font-size-xs);
  font-weight: 600;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 0.75rem;
  display: block;
}

.nav-item {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  padding: 0.875rem 1rem;
  color: var(--text-secondary);
  text-decoration: none;
  border-radius: var(--radius-lg);
  font-weight: 500;
  transition: all 0.2s ease;
  position: relative;
}

.nav-item:hover {
  background: var(--gray-100);
  color: var(--primary);
}

.nav-item.active {
  background: var(--primary);
  color: var(--text-white);
  box-shadow: var(--shadow-md);
}

.nav-item i {
  width: 20px;
  font-size: 1.125rem;
}

.nav-badge {
  margin-left: auto;
  background: var(--gray-300);
  color: var(--text-white);
  font-size: var(--font-size-xs);
  font-weight: 600;
  padding: 0.25rem 0.5rem;
  border-radius: var(--radius-sm);
}

.nav-item.active .nav-badge {
  background: rgba(255, 255, 255, 0.2);
}

.nav-badge.new {
  background: var(--accent);
}

.main-content {
  grid-area: main;
  padding: 2rem;
  max-width: 100%;
  overflow-x: hidden;
}

.content-header {
  display: flex;
  align-items: flex-start;
  justify-content: space-between;
  margin-bottom: 2rem;
}

.page-title h1 {
  font-size: var(--font-size-3xl);
  font-weight: 700;
  color: var(--text-primary);
  margin-bottom: 0.5rem;
}

.page-subtitle {
  color: var(--text-muted);
  font-size: var(--font-size-lg);
  margin: 0;
}

/* Flights-specific styles from flights.css */
:root {
  --primary-color: #4a90e2;
  --card-background: #ffffff;
  --border-color: #e1e5e9;
  --border-radius-lg: 12px;
  --border-radius-md: 8px;
  --border-radius-sm: 4px;
  --text-color: #2d3748;
  --success-color: #48bb78;
}

.search-section {
  margin-bottom: 2rem;
  display: block !important;
  visibility: visible !important;
}

.search-card {
  background: var(--card-background);
  border-radius: var(--border-radius-lg);
  box-shadow: var(--shadow-md);
  overflow: hidden;
  margin-bottom: 2rem;
  display: block !important;
  visibility: visible !important;
}

.search-header {
  background: linear-gradient(135deg, var(--primary-color), #4a90e2);
  padding: 1rem 1.5rem;
  border-bottom: 1px solid var(--border-color);
}

.search-tabs {
  display: flex;
  gap: 0.5rem;
}

.search-tab {
  background: rgba(255, 255, 255, 0.1);
  color: white;
  border: none;
  padding: 0.5rem 1rem;
  border-radius: var(--border-radius-md);
  cursor: pointer;
  transition: all 0.3s ease;
  font-size: 0.9rem;
  display: flex;
  align-items: center;
  gap: 0.5rem;
  backdrop-filter: blur(10px);
}

.search-tab:hover {
  background: rgba(255, 255, 255, 0.2);
  transform: translateY(-2px);
}

.search-tab.active {
  background: white;
  color: var(--primary-color);
  font-weight: 600;
}

.flight-search-form {
  padding: 2rem;
  display: block !important;
  visibility: visible !important;
}

.search-inputs {
  display: grid !important;
  gap: 1.5rem;
  margin-bottom: 2rem;
  visibility: visible !important;
}

.location-inputs {
  display: grid !important;
  grid-template-columns: 1fr auto 1fr;
  gap: 1rem;
  align-items: end;
  visibility: visible !important;
}

.input-group {
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}

.input-label {
  font-weight: 600;
  color: var(--text-color);
  font-size: 0.9rem;
}

.location-input {
  position: relative;
  display: flex;
  align-items: center;
}

.location-input i {
  position: absolute;
  left: 1rem;
  color: var(--text-secondary);
  z-index: 1;
}

.location-input input {
  width: 100%;
  padding: 1rem 1rem 1rem 2.5rem;
  border: 2px solid var(--border-color);
  border-radius: var(--border-radius-md);
  font-size: 1rem;
  transition: all 0.3s ease;
  background: white;
}

.location-input input:focus {
  outline: none;
  border-color: var(--primary-color);
  box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.1);
}

.swap-locations {
  background: var(--primary-color);
  border: none;
  width: 2.5rem;
  height: 2.5rem;
  border-radius: 50%;
  color: white;
  cursor: pointer;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  margin-top: 1.5rem;
}

.swap-locations:hover {
  transform: rotate(180deg) scale(1.1);
  box-shadow: 0 4px 12px rgba(74, 144, 226, 0.4);
}

.date-inputs {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 1rem;
}

.date-input {
  position: relative;
  display: flex;
  align-items: center;
}

.date-input i {
  position: absolute;
  left: 1rem;
  color: var(--text-secondary);
  z-index: 1;
}

.date-input input {
  width: 100%;
  padding: 1rem 1rem 1rem 2.5rem;
  border: 2px solid var(--border-color);
  border-radius: var(--border-radius-md);
  font-size: 1rem;
  transition: all 0.3s ease;
}

.date-input input:focus {
  outline: none;
  border-color: var(--primary-color);
  box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.1);
}

.passenger-selector {
  position: relative;
}

.passenger-btn {
  width: 100%;
  padding: 1rem;
  border: 2px solid var(--border-color);
  border-radius: var(--border-radius-md);
  background: white;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: space-between;
  font-size: 1rem;
  transition: all 0.3s ease;
}

.passenger-btn:hover,
.passenger-btn:focus {
  border-color: var(--primary-color);
  box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.1);
}

.passenger-dropdown {
  position: absolute;
  top: 100%;
  left: 0;
  right: 0;
  background: white;
  border: 2px solid var(--border-color);
  border-top: none;
  border-radius: 0 0 var(--border-radius-md) var(--border-radius-md);
  box-shadow: var(--shadow-lg);
  z-index: 10;
  display: none;
}

.passenger-dropdown.active {
  display: block;
}

.passenger-options {
  padding: 1rem;
}

.passenger-type {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0.75rem 0;
  border-bottom: 1px solid var(--border-color);
}

.passenger-type:last-of-type {
  border-bottom: none;
  margin-bottom: 1rem;
}

.counter {
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.counter-btn {
  width: 2rem;
  height: 2rem;
  border: 1px solid var(--border-color);
  border-radius: 50%;
  background: white;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.3s ease;
}

.counter-btn:hover {
  background: var(--primary-color);
  color: white;
  border-color: var(--primary-color);
}

.counter-value {
  min-width: 1.5rem;
  text-align: center;
  font-weight: 600;
}

.class-options {
  display: flex;
  gap: 1rem;
  flex-wrap: wrap;
}

.class-option {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  cursor: pointer;
}

.class-option input {
  margin: 0;
}

.search-flights-btn {
  width: 100%;
  background: linear-gradient(135deg, var(--primary-color), #4a90e2);
  color: white;
  border: none;
  padding: 1rem 2rem;
  border-radius: var(--border-radius-md);
  font-size: 1.1rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0.5rem;
}

.search-flights-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(74, 144, 226, 0.4);
}

.results-section {
  margin-top: 2rem;
}

.results-layout {
  display: grid;
  grid-template-columns: 280px 1fr;
  gap: 2rem;
}

.filters-sidebar {
  background: var(--card-background);
  border-radius: var(--border-radius-lg);
  box-shadow: var(--shadow-md);
  padding: 1.5rem;
  height: fit-content;
  position: sticky;
  top: 100px;
}

.filters-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1.5rem;
  padding-bottom: 1rem;
  border-bottom: 1px solid var(--border-color);
}

.filters-header h3 {
  margin: 0;
  color: var(--text-color);
}

.clear-filters {
  background: none;
  border: none;
  color: var(--primary-color);
  cursor: pointer;
  font-size: 0.9rem;
  text-decoration: underline;
}

.filter-section {
  margin-bottom: 2rem;
}

.filter-section h4 {
  margin: 0 0 1rem 0;
  color: var(--text-color);
  font-size: 1rem;
}

.price-range {
  margin-bottom: 1rem;
}

.range-slider {
  position: relative;
  height: 6px;
  background: var(--border-color);
  border-radius: 3px;
  margin: 1rem 0;
}

.range-slider input[type="range"] {
  position: absolute;
  width: 100%;
  height: 6px;
  background: none;
  pointer-events: none;
  -webkit-appearance: none;
}

.range-slider input[type="range"]::-webkit-slider-thumb {
  pointer-events: all;
  width: 20px;
  height: 20px;
  border-radius: 50%;
  background: var(--primary-color);
  cursor: pointer;
  -webkit-appearance: none;
  border: 2px solid white;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
}

.price-values {
  display: flex;
  justify-content: space-between;
  font-weight: 600;
  color: var(--text-color);
}

.filter-options,
.time-filters,
.stops-filters {
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}

.time-option,
.stop-option {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  cursor: pointer;
  padding: 0.5rem;
  border-radius: var(--border-radius-sm);
  transition: background-color 0.2s ease;
}

.time-option:hover,
.stop-option:hover {
  background: rgba(74, 144, 226, 0.1);
}

.time-option input,
.stop-option input {
  margin: 0;
}

.results-content {
  display: flex;
  flex-direction: column;
  gap: 1rem;
}

.results-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: var(--card-background);
  padding: 1rem;
  border-radius: var(--border-radius-md);
  box-shadow: var(--shadow-sm);
}

.results-info h3 {
  margin: 0;
  color: var(--text-color);
}

.results-info p {
  margin: 0.25rem 0 0 0;
  color: var(--text-secondary);
  font-size: 0.9rem;
}

.sort-select {
  padding: 0.5rem 1rem;
  border: 2px solid var(--border-color);
  border-radius: var(--border-radius-sm);
  font-size: 0.9rem;
  cursor: pointer;
}

.sort-select:focus {
  outline: none;
  border-color: var(--primary-color);
}

.loading-state {
  text-align: center;
  padding: 3rem;
  background: var(--card-background);
  border-radius: var(--border-radius-md);
  box-shadow: var(--shadow-sm);
}

.loading-spinner {
  font-size: 2rem;
  color: var(--primary-color);
  margin-bottom: 1rem;
}

.loading-spinner i {
  animation: spin 2s linear infinite;
}

@keyframes spin {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}

.flights-list {
  display: flex;
  flex-direction: column;
  gap: 1rem;
}

.flight-card {
  background: var(--card-background);
  border-radius: var(--border-radius-lg);
  box-shadow: var(--shadow-md);
  padding: 1.5rem;
  transition: all 0.3s ease;
  border-left: 4px solid var(--primary-color);
}

.flight-card:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow-lg);
}

.flight-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 1rem;
}

.airline-info {
  display: flex;
  align-items: center;
  gap: 1rem;
}

.airline-logo {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background: var(--border-color);
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  color: white;
  background: var(--primary-color);
}

.airline-details h4 {
  margin: 0;
  color: var(--text-color);
  font-size: 1.1rem;
}

.flight-number {
  color: var(--text-secondary);
  font-size: 0.9rem;
  margin: 0.25rem 0 0 0;
}

.price-info {
  text-align: right;
}

.price {
  font-size: 1.5rem;
  font-weight: bold;
  color: var(--success-color);
  margin: 0;
}

.price-per-person {
  font-size: 0.9rem;
  color: var(--text-secondary);
  margin: 0.25rem 0 0 0;
}

.flight-route {
  display: grid;
  grid-template-columns: 1fr auto 1fr;
  gap: 2rem;
  align-items: center;
  margin-bottom: 1rem;
}

.route-point {
  text-align: center;
}

.route-point.departure {
  text-align: left;
}

.route-point.arrival {
  text-align: right;
}

.airport-code {
  font-size: 1.2rem;
  font-weight: bold;
  color: var(--text-color);
  margin: 0;
}

.airport-name {
  font-size: 0.9rem;
  color: var(--text-secondary);
  margin: 0.25rem 0;
}

.departure-time,
.arrival-time {
  font-size: 1.1rem;
  font-weight: 600;
  color: var(--text-color);
  margin: 0;
}

.route-visual {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 0.5rem;
}

.flight-duration {
  font-size: 0.9rem;
  color: var(--text-secondary);
  font-weight: 500;
}

.route-line {
  width: 100px;
  height: 2px;
  background: linear-gradient(to right, var(--primary-color), var(--success-color));
  position: relative;
}

.route-line::after {
  content: 'âœˆ';
  position: absolute;
  right: -8px;
  top: -8px;
  color: var(--primary-color);
  font-size: 1rem;
}

.stops-info {
  font-size: 0.9rem;
  color: var(--text-secondary);
}

.flight-details-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.flight-info {
  display: flex;
  gap: 2rem;
  font-size: 0.9rem;
  color: var(--text-secondary);
}

.info-item {
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.book-flight-btn {
  background: linear-gradient(135deg, var(--success-color), #28a745);
  color: white;
  border: none;
  padding: 0.75rem 2rem;
  border-radius: var(--border-radius-md);
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.book-flight-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 15px rgba(40, 167, 69, 0.4);
}

.no-flights {
  text-align: center;
  padding: 3rem;
  background: var(--card-background);
  border-radius: var(--border-radius-md);
  box-shadow: var(--shadow-sm);
}

.no-flights i {
  font-size: 3rem;
  color: var(--text-secondary);
  margin-bottom: 1rem;
}

.no-flights h3 {
  color: var(--text-color);
  margin: 0 0 0.5rem 0;
}

.no-flights p {
  color: var(--text-secondary);
  margin: 0;
}

.location-dropdown {
  position: absolute;
  top: 100%;
  left: 0;
  right: 0;
  background: white;
  border: 2px solid var(--border-color);
  border-top: none;
  border-radius: 0 0 var(--border-radius-md) var(--border-radius-md);
  box-shadow: var(--shadow-lg);
  z-index: 10;
  display: none;
  max-height: 200px;
  overflow-y: auto;
}

.location-option {
  padding: 0.75rem 1rem;
  cursor: pointer;
  border-bottom: 1px solid var(--border-color);
  transition: background-color 0.2s ease;
}

.location-option:hover {
  background: rgba(74, 144, 226, 0.1);
}

.location-option:last-child {
  border-bottom: none;
}

/* Responsive Design */
@media (max-width: 1024px) {
  .dashboard-wrapper {
    grid-template-columns: 240px 1fr;
  }
  
  .search-bar input {
    width: 240px;
  }
  
  .results-layout {
    grid-template-columns: 1fr;
  }
  
  .filters-sidebar {
    position: static;
    margin-bottom: 1rem;
  }
}

@media (max-width: 768px) {
  .dashboard-wrapper {
    grid-template-areas:
      "header"
      "main";
    grid-template-columns: 1fr;
  }
  
  .sidebar-toggle {
    display: block;
  }
  
  .search-bar {
    display: none;
  }
  
  .sidebar {
    position: fixed;
    left: -280px;
    top: 70px;
    width: 280px;
    height: calc(100vh - 70px);
    z-index: 1000;
    transition: left 0.3s ease;
  }
  
  .sidebar.open {
    left: 0;
  }
  
  .main-content {
    padding: 1rem;
  }
  
  .search-inputs {
    gap: 1rem;
  }
  
  .location-inputs {
    grid-template-columns: 1fr;
    gap: 1rem;
  }
  
  .swap-locations {
    margin: 0;
    justify-self: center;
  }
  
  .date-inputs {
    grid-template-columns: 1fr;
  }
  
  .flight-route {
    grid-template-columns: 1fr;
    gap: 1rem;
  }
  
  .route-visual {
    order: 2;
  }
  
  .route-point.arrival {
    order: 3;
  }
  
  .flight-details-row {
    flex-direction: column;
    gap: 1rem;
    align-items: stretch;
  }
  
  .flight-info {
    justify-content: space-around;
    flex-wrap: wrap;
    gap: 1rem;
  }
}

@media (max-width: 480px) {
  .header-actions {
    gap: 0.5rem;
  }
  
  .user-menu-trigger span {
    display: none;
  }
  
  .flight-search-form {
    padding: 1rem;
  }
  
  .filters-sidebar {
    padding: 1rem;
  }
  
  .flight-card {
    padding: 1rem;
  }
  
  .search-tabs {
    flex-direction: column;
    gap: 0.25rem;
  }
  
  .search-tab {
    justify-content: center;
  }
}
  </style>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
  <div class="dashboard-wrapper page-fade-in">
    <!-- Dashboard Header -->
    <header class="dashboard-header">
      <div class="header-left">
        <button class="sidebar-toggle" id="sidebarToggle">
          <i class="fas fa-bars"></i>
        </button>
        <div class="brand">
          <img src="../assets/images/img2.webp" alt="TravelEase" class="brand-logo">
          <span class="brand-name">TravelEase</span>
        </div>
      </div>
      
      <div class="header-right">
        <div class="search-bar">
          <i class="fas fa-search"></i>
          <input type="text" placeholder="Search flights, destinations...">
        </div>
        
        <div class="header-actions">
          <button class="icon-btn notifications-btn">
            <i class="fas fa-bell"></i>
            <span class="notification-badge">3</span>
          </button>
          
          <div class="user-menu">
            <button class="user-menu-trigger">
              <img id="userAvatar" src="../assets/images/Yash.jpg" alt="Avatar" class="user-avatar">
              <span id="username">Yash Mittal</span>
              <i class="fas fa-chevron-down"></i>
            </button>
            <div class="user-dropdown">
              <a href="profile.html" class="dropdown-item">
                <i class="fas fa-user"></i> Profile
              </a>
              <a href="wallet.html" class="dropdown-item">
                <i class="fas fa-wallet"></i> Wallet
              </a>
              <div class="dropdown-divider"></div>
              <button id="logoutBtn" class="dropdown-item logout-btn">
                <i class="fas fa-sign-out-alt"></i> Logout
              </button>
            </div>
          </div>
        </div>
      </div>
    </header>

    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-content">
        <div class="sidebar-user">
          <div class="user-avatar-large">
            <img id="sidebarAvatar" src="../assets/images/Yash.jpg" alt="Avatar">
            <div class="status-indicator online"></div>
          </div>
          <div class="user-info">
            <h3 id="sidebarUsername">Yash Mittal</h3>
            <p class="user-status">Premium Member</p>
          </div>
        </div>
        
        <nav class="sidebar-nav">
          <div class="nav-section">
            <span class="nav-section-title">Main</span>
            <a href="dashboard.html" class="nav-item">
              <i class="fas fa-home"></i>
              <span>Dashboard</span>
            </a>
          </div>
          
          <div class="nav-section">
            <span class="nav-section-title">Booking</span>
            <a href="flights.html" class="nav-item active">
              <i class="fas fa-plane-departure"></i>
              <span>Flights</span>
            </a>
            <a href="hotels.html" class="nav-item">
              <i class="fas fa-bed"></i>
              <span>Hotels</span>
            </a>
            <a href="packages.html" class="nav-item">
              <i class="fas fa-suitcase"></i>
              <span>Packages</span>
            </a>
          </div>
          
          <div class="nav-section">
            <span class="nav-section-title">Account</span>
            <a href="offers.html" class="nav-item">
              <i class="fas fa-percent"></i>
              <span>Offers</span>
            </a>
            <a href="wallet.html" class="nav-item">
              <i class="fas fa-wallet"></i>
              <span>Wallet</span>
            </a>
            <a href="profile.html" class="nav-item">
              <i class="fas fa-user-cog"></i>
              <span>Settings</span>
            </a>
          </div>
        </nav>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <div class="content-header">
        <div class="page-title">
          <h1><i class="fas fa-plane-departure"></i> Flight Search</h1>
          <p class="page-subtitle">Find and book the perfect flight for your journey</p>
        </div>
      </div>

      <!-- Flight Search Form -->
      <div class="search-section">
        <div class="search-card">
          <div class="search-header">
            <div class="search-tabs">
              <button class="search-tab active" data-type="roundtrip">
                <i class="fas fa-exchange-alt"></i>
                Round Trip
              </button>
              <button class="search-tab" data-type="oneway">
                <i class="fas fa-long-arrow-alt-right"></i>
                One Way
              </button>
              <button class="search-tab" data-type="multicity">
                <i class="fas fa-route"></i>
                Multi-City
              </button>
            </div>
          </div>
          
          <form id="flightSearchForm" class="flight-search-form">
            <div class="search-inputs">
              <div class="location-inputs">
                <div class="input-group">
                  <label class="input-label">From</label>
                  <div class="location-input">
                    <i class="fas fa-plane-departure"></i>
                    <input id="fromLocation" type="text" placeholder="Departure city" required autocomplete="off">
                    <div class="location-dropdown" id="fromDropdown"></div>
                  </div>
                </div>
                
                <button type="button" class="swap-locations" id="swapLocations">
                  <i class="fas fa-exchange-alt"></i>
                </button>
                
                <div class="input-group">
                  <label class="input-label">To</label>
                  <div class="location-input">
                    <i class="fas fa-plane-arrival"></i>
                    <input id="toLocation" type="text" placeholder="Destination city" required autocomplete="off">
                    <div class="location-dropdown" id="toDropdown"></div>
                  </div>
                </div>
              </div>
              
              <div class="date-inputs">
                <div class="input-group">
                  <label class="input-label">Departure Date</label>
                  <div class="date-input">
                    <i class="fas fa-calendar-alt"></i>
                    <input id="departDate" type="date" required>
                  </div>
                </div>
                
                <div class="input-group" id="returnDateGroup">
                  <label class="input-label">Return Date</label>
                  <div class="date-input">
                    <i class="fas fa-calendar-alt"></i>
                    <input id="returnDate" type="date">
                  </div>
                </div>
              </div>
              
              <div class="passenger-inputs">
                <div class="input-group">
                  <label class="input-label">Passengers & Class</label>
                  <div class="passenger-selector">
                    <button type="button" class="passenger-btn" id="passengerBtn">
                      <i class="fas fa-users"></i>
                      <span>1 Adult, Economy</span>
                      <i class="fas fa-chevron-down"></i>
                    </button>
                    <div class="passenger-dropdown" id="passengerDropdown">
                      <div class="passenger-options">
                        <div class="passenger-type">
                          <span>Adults</span>
                          <div class="counter">
                            <button type="button" class="counter-btn" data-action="minus" data-type="adults">-</button>
                            <span class="counter-value" data-type="adults">1</span>
                            <button type="button" class="counter-btn" data-action="plus" data-type="adults">+</button>
                          </div>
                        </div>
                        <div class="passenger-type">
                          <span>Children (2-11)</span>
                          <div class="counter">
                            <button type="button" class="counter-btn" data-action="minus" data-type="children">-</button>
                            <span class="counter-value" data-type="children">0</span>
                            <button type="button" class="counter-btn" data-action="plus" data-type="children">+</button>
                          </div>
                        </div>
                        <div class="passenger-type">
                          <span>Infants (0-2)</span>
                          <div class="counter">
                            <button type="button" class="counter-btn" data-action="minus" data-type="infants">-</button>
                            <span class="counter-value" data-type="infants">0</span>
                            <button type="button" class="counter-btn" data-action="plus" data-type="infants">+</button>
                          </div>
                        </div>
                        <div class="class-options">
                          <label class="class-option">
                            <input type="radio" name="class" value="economy" checked>
                            <span>Economy</span>
                          </label>
                          <label class="class-option">
                            <input type="radio" name="class" value="business">
                            <span>Business</span>
                          </label>
                          <label class="class-option">
                            <input type="radio" name="class" value="first">
                            <span>First Class</span>
                          </label>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <button type="submit" class="search-flights-btn">
              <i class="fas fa-search"></i>
              Search Flights
            </button>
          </form>
        </div>
      </div>

      <!-- Filters and Results -->
      <div class="results-section" id="resultsSection" style="display: none;">
        <div class="results-layout">
          <!-- Filters Sidebar -->
          <aside class="filters-sidebar">
            <div class="filters-header">
              <h3>Filter Results</h3>
              <button class="clear-filters" id="clearFilters">Clear All</button>
            </div>
            
            <div class="filter-section">
              <h4>Price Range</h4>
              <div class="price-range">
                <div class="range-slider">
                  <input type="range" id="minPrice" min="0" max="2000" value="0">
                  <input type="range" id="maxPrice" min="0" max="2000" value="2000">
                </div>
                <div class="price-values">
                  <span>$<span id="minPriceValue">0</span></span>
                  <span>$<span id="maxPriceValue">2000</span></span>
                </div>
              </div>
            </div>
            
            <div class="filter-section">
              <h4>Airlines</h4>
              <div class="filter-options" id="airlinesFilter"></div>
            </div>
            
            <div class="filter-section">
              <h4>Departure Time</h4>
              <div class="time-filters">
                <label class="time-option">
                  <input type="checkbox" value="morning">
                  <span><i class="fas fa-sun"></i> Morning (6AM - 12PM)</span>
                </label>
                <label class="time-option">
                  <input type="checkbox" value="afternoon">
                  <span><i class="fas fa-sun"></i> Afternoon (12PM - 6PM)</span>
                </label>
                <label class="time-option">
                  <input type="checkbox" value="evening">
                  <span><i class="fas fa-moon"></i> Evening (6PM - 12AM)</span>
                </label>
              </div>
            </div>
            
            <div class="filter-section">
              <h4>Stops</h4>
              <div class="stops-filters">
                <label class="stop-option">
                  <input type="radio" name="stops" value="any" checked>
                  <span>Any number of stops</span>
                </label>
                <label class="stop-option">
                  <input type="radio" name="stops" value="nonstop">
                  <span>Nonstop only</span>
                </label>
                <label class="stop-option">
                  <input type="radio" name="stops" value="1stop">
                  <span>1 stop or fewer</span>
                </label>
              </div>
            </div>
          </aside>
          
          <!-- Results Content -->
          <div class="results-content">
            <div class="results-header">
              <div class="results-info">
                <h3 id="resultsTitle">Flight Results</h3>
                <p id="resultsCount">Searching for flights...</p>
              </div>
              <div class="sort-options">
                <select id="sortBy" class="sort-select">
                  <option value="price">Sort by Price</option>
                  <option value="duration">Sort by Duration</option>
                  <option value="departure">Sort by Departure</option>
                  <option value="arrival">Sort by Arrival</option>
                </select>
              </div>
            </div>
            
            <div class="loading-state" id="loadingState">
              <div class="loading-spinner">
                <i class="fas fa-plane fa-spin"></i>
              </div>
              <p>Searching for the best flights...</p>
            </div>
            
            <div class="flights-list" id="flightResults"></div>
          </div>
        </div>
      </div>
    </main>
  </div>
  
  <script>
    // Include dashboard.js functionality for sidebar and user management
    document.addEventListener('DOMContentLoaded', () => {
      // Dashboard initialization
      const sidebarToggle = document.getElementById('sidebarToggle');
      const sidebar = document.getElementById('sidebar');
      const logoutBtn = document.getElementById('logoutBtn');
      
      if (sidebarToggle && sidebar) {
        sidebarToggle.addEventListener('click', () => {
          sidebar.classList.toggle('open');
        });
        
        document.addEventListener('click', (e) => {
          if (!sidebar.contains(e.target) && !sidebarToggle.contains(e.target)) {
            sidebar.classList.remove('open');
          }
        });
      }
      
      if (logoutBtn) {
        logoutBtn.addEventListener('click', () => {
          if (confirm('Are you sure you want to logout?')) {
            localStorage.removeItem('isLoggedIn');
            localStorage.removeItem('currentUserEmail');
            window.location.href = 'login.html';
          }
        });
      }
      
      // Initialize flight search
      initializeFlightSearch();
      initializePassengerSelector();
      initializeLocationAutocomplete();
      initializeFilters();
      setMinDates();
      
      // Load initial flights on page load
      loadInitialFlights();
      
      // Listen for profile updates
      window.addEventListener('storage', function(e) {
        if (e.key === 'travelEaseUser') {
          updateUserDisplays();
        }
      });
      
      window.addEventListener('profileUpdated', function(e) {
        updateUserDisplays();
      });
      
      updateUserDisplays();
    });

    // Flight search functionality
    async function loadInitialFlights() {
      try {
        console.log('ðŸ”„ Loading initial flights...');
        
        const resultsSection = document.getElementById('resultsSection');
        const loadingState = document.getElementById('loadingState');
        const flightResults = document.getElementById('flightResults');
        const resultsCount = document.getElementById('resultsCount');
        
        // Show results section and loading state
        resultsSection.style.display = 'block';
        loadingState.style.display = 'block';
        flightResults.innerHTML = '';
        
        try {
          // Try to load flights from backend
          const response = await fetch('/api/flights', {
            method: 'GET',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${localStorage.getItem('userToken') || ''}`
            }
          });
          
          if (response.ok) {
            const apiResponse = await response.json();
            console.log('âœ… Initial flights loaded from backend:', apiResponse);
            
            let flights;
            if (apiResponse.success && apiResponse.data) {
              flights = apiResponse.data;
            } else if (Array.isArray(apiResponse)) {
              flights = apiResponse;
            } else {
              flights = [];
            }
            
            if (flights && flights.length > 0) {
              // Transform backend response to match frontend format
              currentFlights = flights.map((flight, index) => ({
                id: flight._id || flight.id || `flight_${index}`,
                _id: flight._id || flight.id,
                airline: flight.airline || 'Unknown Airline',
                airlineCode: flight.airline ? flight.airline.substring(0, 2).toUpperCase() : 'UA',
                airlineLogo: flight.airline ? flight.airline.substring(0, 2).toUpperCase() : 'UA',
                flightNumber: flight.flightNumber || `FL${Math.random().toString().substr(2, 4)}`,
                departureTime: flight.depart || flight.departureTime || '08:00',
                arrivalTime: flight.return || flight.arrivalTime || '12:00',
                duration: flight.duration || '4h 0m',
                stops: flight.stops || 0,
                stopsText: (flight.stops || 0) === 0 ? 'Nonstop' : `${flight.stops || 0} stop${(flight.stops || 0) > 1 ? 's' : ''}`,
                price: flight.price || 0,
                availableSeats: flight.availableSeats || 0,
                from: flight.from || 'NYC',
                to: flight.to || 'LAX',
                fromFull: flight.from ? `${flight.from} - Airport` : 'NYC - New York',
                toFull: flight.to ? `${flight.to} - Airport` : 'LAX - Los Angeles',
                departureHour: parseInt((flight.depart || flight.departureTime || '08:00').split(':')[0]) || 8,
                status: flight.status || 'active',
                aircraft: flight.aircraft || 'Boeing 737',
                terminal: flight.terminal || 'Terminal 1'
              }));
              
              filteredFlights = [...currentFlights];
              
              console.log(`ðŸ“‹ Loaded ${currentFlights.length} flights from backend`);
            } else {
              console.log('âš ï¸ No flights in backend, using mock data');
              currentFlights = generateMockFlights({ from: 'NYC', to: 'LAX', class: 'economy' });
              filteredFlights = [...currentFlights];
            }
          } else {
            console.log('âŒ Backend request failed, using mock data');
            currentFlights = generateMockFlights({ from: 'NYC', to: 'LAX', class: 'economy' });
            filteredFlights = [...currentFlights];
          }
        } catch (backendError) {
          console.warn('ðŸ”„ Backend error, using mock data:', backendError);
          currentFlights = generateMockFlights({ from: 'NYC', to: 'LAX', class: 'economy' });
          filteredFlights = [...currentFlights];
        }
        
        // Hide loading and show results
        loadingState.style.display = 'none';
        
        if (currentFlights.length === 0) {
          displayNoFlights();
          resultsCount.textContent = 'No flights available';
        } else {
          displayFlights(filteredFlights);
          resultsCount.textContent = `${filteredFlights.length} flights available`;
          populateAirlineFilters();
        }
        
        console.log('âœ… Initial flights loaded successfully');
        
      } catch (error) {
        console.error('âŒ Error loading initial flights:', error);
        
        // Show error or fallback to mock data
        const loadingState = document.getElementById('loadingState');
        if (loadingState) loadingState.style.display = 'none';
        
        try {
          currentFlights = generateMockFlights({ from: 'NYC', to: 'LAX', class: 'economy' });
          filteredFlights = [...currentFlights];
          displayFlights(filteredFlights);
          
          const resultsCount = document.getElementById('resultsCount');
          if (resultsCount) {
            resultsCount.textContent = `${filteredFlights.length} flights available`;
          }
          populateAirlineFilters();
        } catch (fallbackError) {
          console.error('âŒ Failed to load fallback flights:', fallbackError);
          displayErrorMessage();
        }
      }
    }
    let passengerCounts = { adults: 1, children: 0, infants: 0 };
    let selectedClass = 'economy';
    let currentFlights = [];
    let filteredFlights = [];

    function initializeFlightSearch() {
      try {
        const searchForm = document.getElementById('flightSearchForm');
        const searchTabs = document.querySelectorAll('.search-tab');
        const swapBtn = document.getElementById('swapLocations');
        
        if (!searchForm) {
          console.warn('Flight search form not found');
          return;
        }
        
        // Search tabs functionality
        searchTabs.forEach(tab => {
          tab.addEventListener('click', function() {
            searchTabs.forEach(t => t.classList.remove('active'));
            this.classList.add('active');
            
            const type = this.dataset.type;
            const returnDateGroup = document.getElementById('returnDateGroup');
            
            if (returnDateGroup) {
              if (type === 'oneway') {
                returnDateGroup.style.display = 'none';
              } else {
                returnDateGroup.style.display = 'block';
              }
            }
          });
        });
        
        // Swap locations functionality
        if (swapBtn) {
          swapBtn.addEventListener('click', function() {
            const fromInput = document.getElementById('fromLocation');
            const toInput = document.getElementById('toLocation');
            
            if (fromInput && toInput) {
              const temp = fromInput.value;
              fromInput.value = toInput.value;
              toInput.value = temp;
            }
          });
        }
        
        // Form submission
        searchForm.addEventListener('submit', function(e) {
          e.preventDefault();
          performFlightSearch();
        });
        
        console.log('Flight search initialized successfully');
      } catch (error) {
        console.error('Error initializing flight search:', error);
      }
    }

    function initializePassengerSelector() {
      const passengerBtn = document.getElementById('passengerBtn');
      const passengerDropdown = document.getElementById('passengerDropdown');
      const counterBtns = document.querySelectorAll('.counter-btn');
      const classOptions = document.querySelectorAll('input[name="class"]');
      
      // Toggle dropdown
      passengerBtn.addEventListener('click', function() {
        passengerDropdown.classList.toggle('active');
      });
      
      // Close dropdown when clicking outside
      document.addEventListener('click', function(e) {
        if (!passengerBtn.contains(e.target) && !passengerDropdown.contains(e.target)) {
          passengerDropdown.classList.remove('active');
        }
      });
      
      // Counter functionality
      counterBtns.forEach(btn => {
        btn.addEventListener('click', function() {
          const action = this.dataset.action;
          const type = this.dataset.type;
          const counterValue = document.querySelector(`.counter-value[data-type="${type}"]`);
          
          if (!counterValue) {
            console.error(`Counter element not found for type: ${type}`);
            return;
          }
          
          // Get current value and ensure it's a valid number
          let currentValue = parseInt(counterValue.textContent) || 0;
          
          // Ensure we have the correct initial value from global state
          if (isNaN(currentValue) || currentValue < 0) {
            currentValue = passengerCounts[type] || 0;
            if (type === 'adults' && currentValue === 0) {
              currentValue = 1; // Adults should never be 0
            }
          }
          
          if (action === 'plus') {
            if (type === 'adults' && currentValue < 9) {
              currentValue++;
            } else if (type === 'children' && currentValue < 8) {
              currentValue++;
            } else if (type === 'infants' && currentValue < passengerCounts.adults) {
              currentValue++;
            }
          } else if (action === 'minus') {
            if (type === 'adults' && currentValue > 1) {
              currentValue--;
            } else if ((type === 'children' || type === 'infants') && currentValue > 0) {
              currentValue--;
            }
          }
          
          // Update both the display and global state
          counterValue.textContent = currentValue;
          passengerCounts[type] = currentValue;
          
          // Update infant limit based on adults
          if (type === 'adults') {
            const infantCounter = document.querySelector('.counter-value[data-type="infants"]');
            if (infantCounter) {
              const infantCount = parseInt(infantCounter.textContent) || 0;
              if (infantCount > currentValue) {
                infantCounter.textContent = currentValue;
                passengerCounts.infants = currentValue;
              }
            }
          }
          
          updatePassengerDisplay();
        });
      });
      
      // Class selection
      classOptions.forEach(option => {
        option.addEventListener('change', function() {
          selectedClass = this.value;
          updatePassengerDisplay();
        });
      });
    }

    function updatePassengerDisplay() {
      try {
        const total = passengerCounts.adults + passengerCounts.children;
        const passengerText = `${total} ${total === 1 ? 'Passenger' : 'Passengers'}, ${selectedClass.charAt(0).toUpperCase() + selectedClass.slice(1)}`;
        const spanElement = document.querySelector('#passengerBtn span');
        if (spanElement) {
          spanElement.textContent = passengerText;
        } else {
          console.warn('Passenger button span not found');
        }
      } catch (error) {
        console.error('Error updating passenger display:', error);
      }
    }

    function initializeLocationAutocomplete() {
      const cities = [
        { code: 'NYC', name: 'New York', country: 'USA' },
        { code: 'LAX', name: 'Los Angeles', country: 'USA' },
        { code: 'LHR', name: 'London', country: 'UK' },
        { code: 'CDG', name: 'Paris', country: 'France' },
        { code: 'DXB', name: 'Dubai', country: 'UAE' },
        { code: 'NRT', name: 'Tokyo', country: 'Japan' },
        { code: 'SIN', name: 'Singapore', country: 'Singapore' },
        { code: 'SYD', name: 'Sydney', country: 'Australia' },
        { code: 'FRA', name: 'Frankfurt', country: 'Germany' },
        { code: 'AMS', name: 'Amsterdam', country: 'Netherlands' }
      ];
      
      const locationInputs = ['fromLocation', 'toLocation'];
      
      locationInputs.forEach(inputId => {
        const input = document.getElementById(inputId);
        const dropdown = document.getElementById(inputId.replace('Location', 'Dropdown'));
        
        input.addEventListener('input', function() {
          const query = this.value.toLowerCase();
          const matches = cities.filter(city => 
            city.name.toLowerCase().includes(query) ||
            city.code.toLowerCase().includes(query) ||
            city.country.toLowerCase().includes(query)
          );
          
          if (query.length > 0 && matches.length > 0) {
            dropdown.innerHTML = matches.map(city => 
              `<div class="location-option" data-code="${city.code}" data-name="${city.name}">
                <strong>${city.code}</strong> - ${city.name}, ${city.country}
              </div>`
            ).join('');
            dropdown.style.display = 'block';
            
            // Add click handlers
            dropdown.querySelectorAll('.location-option').forEach(option => {
              option.addEventListener('click', function() {
                input.value = `${this.dataset.code} - ${this.dataset.name}`;
                dropdown.style.display = 'none';
              });
            });
          } else {
            dropdown.style.display = 'none';
          }
        });
        
        // Hide dropdown when clicking outside
        document.addEventListener('click', function(e) {
          if (!input.contains(e.target) && !dropdown.contains(e.target)) {
            dropdown.style.display = 'none';
          }
        });
      });
    }

    function setMinDates() {
      const today = new Date().toISOString().split('T')[0];
      const departInput = document.getElementById('departDate');
      const returnInput = document.getElementById('returnDate');
      
      departInput.min = today;
      returnInput.min = today;
      
      departInput.addEventListener('change', function() {
        returnInput.min = this.value;
        if (returnInput.value && returnInput.value < this.value) {
          returnInput.value = this.value;
        }
      });
    }

    function performFlightSearch() {
      const fromLocation = document.getElementById('fromLocation').value;
      const toLocation = document.getElementById('toLocation').value;
      const departDate = document.getElementById('departDate').value;
      const returnDate = document.getElementById('returnDate').value;
      
      if (!fromLocation || !toLocation || !departDate) {
        alert('Please fill in all required fields');
        return;
      }
      
      const resultsSection = document.getElementById('resultsSection');
      const loadingState = document.getElementById('loadingState');
      const flightResults = document.getElementById('flightResults');
      const resultsCount = document.getElementById('resultsCount');
      
      resultsSection.style.display = 'block';
      loadingState.style.display = 'block';
      flightResults.innerHTML = '';
      
      // Fetch flights
      fetchFlights(fromLocation, toLocation, departDate, returnDate)
        .then(flights => {
          currentFlights = flights;
          filteredFlights = [...currentFlights];
          
          loadingState.style.display = 'none';
          
          if (flights.length === 0) {
            displayNoFlights();
            resultsCount.textContent = 'No flights found for your search criteria';
          } else {
            displayFlights(filteredFlights);
            resultsCount.textContent = `${filteredFlights.length} flights found`;
            populateAirlineFilters();
          }
        })
        .catch(error => {
          console.error('Flight search failed:', error);
          loadingState.style.display = 'none';
          displayErrorMessage();
          resultsCount.textContent = 'Error loading flights. Please try again.';
          currentFlights = [];
          filteredFlights = [];
        });
    }

    async function fetchFlights(from, to, depart, returnDate = null) {
      try {
        const searchParams = {
          from: from.includes(' - ') ? from.split(' - ')[0] : from,
          to: to.includes(' - ') ? to.split(' - ')[0] : to,
          depart,
          returnDate,
          passengers: passengerCounts,
          class: selectedClass
        };

        // If no specific search criteria, load all flights first
        if (!from && !to) {
          console.log('Loading all available flights...');
          try {
            const response = await fetch('/api/flights', {
              method: 'GET',
              headers: { 
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${localStorage.getItem('userToken') || ''}` 
              }
            });
            
            if (response.ok) {
              const apiResponse = await response.json();
              console.log('All flights loaded from backend:', apiResponse);
              
              let flights;
              if (apiResponse.success && apiResponse.data) {
                flights = apiResponse.data;
              } else if (Array.isArray(apiResponse)) {
                flights = apiResponse;
              } else {
                flights = [];
              }
              
              if (flights && flights.length > 0) {
                console.log(`Found ${flights.length} flights from backend`);
                return flights.map((flight, index) => ({
                  id: flight._id || flight.id || `flight_${index}`,
                  _id: flight._id || flight.id,
                  airline: flight.airline || 'Unknown Airline',
                  airlineCode: flight.airline ? flight.airline.substring(0, 2).toUpperCase() : 'UA',
                  airlineLogo: flight.airline ? flight.airline.substring(0, 2).toUpperCase() : 'UA',
                  flightNumber: flight.flightNumber || `FL${Math.random().toString().substr(2, 4)}`,
                  departureTime: flight.depart || flight.departureTime || '08:00',
                  arrivalTime: flight.return || flight.arrivalTime || '12:00',
                  duration: flight.duration || '4h 0m',
                  stops: flight.stops || 0,
                  stopsText: (flight.stops || 0) === 0 ? 'Nonstop' : `${flight.stops || 0} stop${(flight.stops || 0) > 1 ? 's' : ''}`,
                  price: flight.price || 0,
                  availableSeats: flight.availableSeats || 0,
                  from: flight.from || 'NYC',
                  to: flight.to || 'LAX',
                  fromFull: flight.from || 'NYC - New York',
                  toFull: flight.to || 'LAX - Los Angeles',
                  departureHour: parseInt((flight.depart || flight.departureTime || '08:00').split(':')[0]) || 8,
                  status: flight.status || 'active',
                  aircraft: flight.aircraft || 'Boeing 737',
                  terminal: flight.terminal || 'Terminal 1'
                }));
              }
            }
          } catch (error) {
            console.warn('Failed to load all flights, trying search...', error);
          }
        }

        // Try backend search
        try {
          console.log('Making request to /api/flights/search with params:', searchParams);
          
          const response = await fetch('/api/flights/search', {
            method: 'POST',
            headers: { 
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${localStorage.getItem('userToken') || ''}` 
            },
            body: JSON.stringify(searchParams)
          });
          
          console.log('Response status:', response.status);
          
          if (response.ok) {
            const apiResponse = await response.json();
            console.log('Backend response:', apiResponse);
            
            // Handle new API response structure
            let flights;
            if (apiResponse.success && apiResponse.data) {
              flights = apiResponse.data;
            } else if (Array.isArray(apiResponse)) {
              flights = apiResponse;
            } else {
              flights = [];
            }
            
            if (flights && flights.length > 0) {
              console.log(`Found ${flights.length} flights from backend`);
              
              return flights.map((flight, index) => ({
                id: flight._id || flight.id || `flight_${index}`,
                _id: flight._id || flight.id,
                airline: flight.airline || 'Unknown Airline',
                airlineCode: flight.airline ? flight.airline.substring(0, 2).toUpperCase() : 'UA',
                airlineLogo: flight.airline ? flight.airline.substring(0, 2).toUpperCase() : 'UA',
                flightNumber: flight.flightNumber || `FL${Math.random().toString().substr(2, 4)}`,
                departureTime: flight.depart || flight.departureTime || '08:00',
                arrivalTime: flight.return || flight.arrivalTime || '12:00',
                duration: flight.duration || '4h 0m',
                stops: flight.stops || 0,
                stopsText: (flight.stops || 0) === 0 ? 'Nonstop' : `${flight.stops || 0} stop${(flight.stops || 0) > 1 ? 's' : ''}`,
                price: flight.price || 0,
                availableSeats: flight.availableSeats || 0,
                from: flight.from || (from.includes(' - ') ? from.split(' - ')[0] : from),
                to: flight.to || (to.includes(' - ') ? to.split(' - ')[0] : to),
                fromFull: from,
                toFull: to,
                departureHour: parseInt((flight.depart || flight.departureTime || '08:00').split(':')[0]) || 8,
                status: flight.status || 'active',
                aircraft: flight.aircraft || 'Boeing 737',
                terminal: flight.terminal || 'Terminal 1'
              }));
            } else {
              console.log('No flights returned from backend, using mock data');
            }
          } else {
            console.log(`Backend request failed with status ${response.status}, using mock data`);
          }
          
        } catch (backendError) {
          console.warn('Backend error, using mock data:', backendError);
        }
        
        // Fallback to mock data
        console.log('Using mock flight data for demo purposes');
        return generateMockFlights(searchParams);
        
      } catch (error) {
        console.error('Flight search error:', error);
        throw error;
      }
    }

    function generateMockFlights(searchParams) {
      const airlines = [
        { name: 'Delta Air Lines', code: 'DL' },
        { name: 'American Airlines', code: 'AA' },
        { name: 'United Airlines', code: 'UA' },
        { name: 'Southwest Airlines', code: 'SW' },
        { name: 'JetBlue Airways', code: 'B6' },
        { name: 'Alaska Airlines', code: 'AS' },
        { name: 'Spirit Airlines', code: 'NK' },
        { name: 'Frontier Airlines', code: 'F9' }
      ];
      
      const mockFlights = [];
      const fromCode = searchParams.from;
      const toCode = searchParams.to;
      
      const numFlights = Math.floor(Math.random() * 5) + 8;
      
      for (let i = 0; i < numFlights; i++) {
        const airline = airlines[Math.floor(Math.random() * airlines.length)];
        const basePrice = Math.floor(Math.random() * 500) + 150;
        const classMultiplier = searchParams.class === 'business' ? 2.5 : searchParams.class === 'first' ? 4 : 1;
        const finalPrice = Math.floor(basePrice * classMultiplier);
        
        const departHour = Math.floor(Math.random() * 18) + 6;
        const departMinute = Math.floor(Math.random() * 4) * 15;
        const flightDurationMinutes = Math.floor(Math.random() * 360) + 120;
        const arrivalTime = new Date();
        arrivalTime.setHours(departHour);
        arrivalTime.setMinutes(departMinute + flightDurationMinutes);
        
        const stops = Math.random() < 0.6 ? 0 : Math.random() < 0.8 ? 1 : 2;
        const stopsText = stops === 0 ? 'Nonstop' : `${stops} stop${stops > 1 ? 's' : ''}`;
        
        mockFlights.push({
          id: `flight_${i}_${Date.now()}`,
          airline: airline.name,
          airlineCode: airline.code,
          airlineLogo: airline.code,
          flightNumber: `${airline.code}${Math.floor(Math.random() * 9000) + 1000}`,
          departureTime: `${departHour.toString().padStart(2, '0')}:${departMinute.toString().padStart(2, '0')}`,
          arrivalTime: `${arrivalTime.getHours().toString().padStart(2, '0')}:${arrivalTime.getMinutes().toString().padStart(2, '0')}`,
          duration: `${Math.floor(flightDurationMinutes / 60)}h ${flightDurationMinutes % 60}m`,
          stops: stops,
          stopsText: stopsText,
          price: finalPrice,
          availableSeats: Math.floor(Math.random() * 200) + 20,
          from: fromCode,
          to: toCode,
          fromFull: `${fromCode} - Airport`,
          toFull: `${toCode} - Airport`,
          departureHour: departHour,
          status: 'active',
          aircraft: ['Boeing 737', 'Airbus A320', 'Boeing 777', 'Airbus A330'][Math.floor(Math.random() * 4)],
          terminal: `Terminal ${Math.floor(Math.random() * 4) + 1}`
        });
      }
      
      return mockFlights.sort((a, b) => a.price - b.price);
    }

    function displayFlights(flights) {
      const flightResults = document.getElementById('flightResults');
      
      if (flights.length === 0) {
        flightResults.innerHTML = `
          <div class="no-flights">
            <i class="fas fa-plane-slash"></i>
            <h3>No flights found</h3>
            <p>Try adjusting your search criteria</p>
          </div>
        `;
        return;
      }
      
      flightResults.innerHTML = flights.map((flight, index) => `
        <div class="flight-card" data-flight-id="${flight.id}">
          <div class="flight-header">
            <div class="airline-info">
              <div class="airline-logo">${flight.airlineLogo}</div>
              <div class="airline-details">
                <h4>${flight.airline}</h4>
                <p class="flight-number">${flight.flightNumber}</p>
              </div>
            </div>
            <div class="price-info">
              <h3 class="price">$${flight.price}</h3>
              <p class="price-per-person">per person</p>
            </div>
          </div>
          
          <div class="flight-route">
            <div class="route-point departure">
              <h4 class="airport-code">${flight.from}</h4>
              <p class="airport-name">${flight.fromFull.split(' - ')[1] || 'Airport'}</p>
              <h3 class="departure-time">${flight.departureTime}</h3>
            </div>
            
            <div class="route-visual">
              <div class="flight-duration">${flight.duration}</div>
              <div class="route-line"></div>
              <div class="stops-info">${flight.stopsText}</div>
            </div>
            
            <div class="route-point arrival">
              <h4 class="airport-code">${flight.to}</h4>
              <p class="airport-name">${flight.toFull.split(' - ')[1] || 'Airport'}</p>
              <h3 class="arrival-time">${flight.arrivalTime}</h3>
            </div>
          </div>
          
          <div class="flight-details-row">
            <div class="flight-info">
              <div class="info-item">
                <i class="fas fa-suitcase-rolling"></i>
                <span>1 carry-on, 1 checked bag</span>
              </div>
              <div class="info-item">
                <i class="fas fa-wifi"></i>
                <span>WiFi available</span>
              </div>
              <div class="info-item">
                <i class="fas fa-utensils"></i>
                <span>Meal included</span>
              </div>
            </div>
            <button class="book-flight-btn" id="book-flight-${index}" data-flight-id="${flight.id}">
              <i class="fas fa-credit-card"></i>
              Book Flight
            </button>
          </div>
        </div>
      `).join('');
      
      // Add event listeners for booking buttons
      flights.forEach((flight, index) => {
        const bookButton = document.getElementById(`book-flight-${index}`);
        if (bookButton) {
          bookButton.addEventListener('click', function() {
            console.log(`âœˆï¸ Book button clicked for flight: ${flight.id}`);
            bookFlight(flight.id);
          });
        }
      });
      
      console.log(`ðŸ“‹ Added event listeners for ${flights.length} flight booking buttons`);
    }

    function initializeFilters() {
      const priceRangeInputs = document.querySelectorAll('#minPrice, #maxPrice');
      const sortSelect = document.getElementById('sortBy');
      const clearFiltersBtn = document.getElementById('clearFilters');
      
      // Price range filters with debouncing for better server performance
      let filterTimeout;
      priceRangeInputs.forEach(input => {
        input.addEventListener('input', function() {
          document.getElementById('minPriceValue').textContent = document.getElementById('minPrice').value;
          document.getElementById('maxPriceValue').textContent = document.getElementById('maxPrice').value;
          
          clearTimeout(filterTimeout);
          filterTimeout = setTimeout(() => {
            applyFilters();
          }, 500); // Debounce filter requests
        });
      });
      
      // Time filters
      document.querySelectorAll('.time-option input').forEach(checkbox => {
        checkbox.addEventListener('change', applyFilters);
      });
      
      // Stops filters
      document.querySelectorAll('.stop-option input').forEach(radio => {
        radio.addEventListener('change', applyFilters);
      });
      
      // Airline filters (dynamic)
      populateAirlineFilters();
      
      // Sort functionality
      if (sortSelect) {
        sortSelect.addEventListener('change', function() {
          const sortValue = this.value;
          console.log('Sorting flights by:', sortValue);
          sortFlights(sortValue);
        });
      }
      
      // Clear filters
      if (clearFiltersBtn) {
        clearFiltersBtn.addEventListener('click', function() {
          console.log('Clearing all filters');
          
          // Reset price range
          document.getElementById('minPrice').value = 0;
          document.getElementById('maxPrice').value = 2000;
          document.getElementById('minPriceValue').textContent = '0';
          document.getElementById('maxPriceValue').textContent = '2000';
          
          // Reset time filters
          document.querySelectorAll('.time-option input').forEach(cb => cb.checked = false);
          
          // Reset stops filter
          const anyStopsRadio = document.querySelector('input[value="any"]');
          if (anyStopsRadio) anyStopsRadio.checked = true;
          
          // Reset airline filters
          document.querySelectorAll('#airlinesFilter input[type="checkbox"]').forEach(cb => cb.checked = false);
          
          // Reload all flights
          loadInitialFlights();
        });
      }
    }

    async function applyFilters() {
      try {
        const minPrice = parseInt(document.getElementById('minPrice')?.value || 0);
        const maxPrice = parseInt(document.getElementById('maxPrice')?.value || 2000);
        const selectedTimes = Array.from(document.querySelectorAll('.time-option input:checked')).map(cb => cb.value);
        const selectedStops = document.querySelector('input[name="stops"]:checked')?.value || 'any';
        const selectedAirlines = Array.from(document.querySelectorAll('#airlinesFilter input:checked')).map(cb => cb.value);
        
        console.log('Applying filters:', { minPrice, maxPrice, selectedTimes, selectedStops, selectedAirlines });
        
        // If no flights loaded or using mock data, filter locally
        if (!currentFlights.length) {
          console.log('No flights to filter');
          return;
        }
        
        // Try backend filtering for better performance on large datasets
        try {
          const filterParams = new URLSearchParams();
          
          if (minPrice > 0) filterParams.append('minPrice', minPrice);
          if (maxPrice < 2000) filterParams.append('maxPrice', maxPrice);
          
          if (selectedTimes.length > 0) {
            selectedTimes.forEach(time => filterParams.append('departureTime', time));
          }
          
          if (selectedStops !== 'any') {
            if (selectedStops === 'nonstop') filterParams.append('stops', '0');
            else if (selectedStops === '1stop') filterParams.append('maxStops', '1');
          }
          
          if (selectedAirlines.length > 0) {
            selectedAirlines.forEach(airline => filterParams.append('airline', airline));
          }
          
          console.log('Backend filter URL params:', filterParams.toString());
          
          const response = await fetch(`/api/flights/filter?${filterParams.toString()}`, {
            method: 'GET',
            headers: { 
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${localStorage.getItem('userToken') || ''}` 
            }
          });
          
          if (response.ok) {
            const apiResponse = await response.json();
            console.log('Backend filter response:', apiResponse);
            
            let backendFlights;
            if (apiResponse.success && apiResponse.data) {
              backendFlights = apiResponse.data;
            } else if (Array.isArray(apiResponse)) {
              backendFlights = apiResponse;
            }
            
            if (backendFlights && backendFlights.length >= 0) {
              // Transform backend response to match frontend format
              filteredFlights = backendFlights.map((flight, index) => ({
                id: flight._id || flight.id || `flight_${index}`,
                _id: flight._id || flight.id,
                airline: flight.airline || 'Unknown Airline',
                airlineCode: flight.airline ? flight.airline.substring(0, 2).toUpperCase() : 'UA',
                airlineLogo: flight.airline ? flight.airline.substring(0, 2).toUpperCase() : 'UA',
                flightNumber: flight.flightNumber || `FL${Math.random().toString().substr(2, 4)}`,
                departureTime: flight.depart || flight.departureTime || '08:00',
                arrivalTime: flight.return || flight.arrivalTime || '12:00',
                duration: flight.duration || '4h 0m',
                stops: flight.stops || 0,
                stopsText: (flight.stops || 0) === 0 ? 'Nonstop' : `${flight.stops || 0} stop${(flight.stops || 0) > 1 ? 's' : ''}`,
                price: flight.price || 0,
                availableSeats: flight.availableSeats || 0,
                from: flight.from || 'NYC',
                to: flight.to || 'LAX',
                fromFull: flight.from || 'NYC - New York',
                toFull: flight.to || 'LAX - Los Angeles',
                departureHour: parseInt((flight.depart || flight.departureTime || '08:00').split(':')[0]) || 8,
                status: flight.status || 'active',
                aircraft: flight.aircraft || 'Boeing 737',
                terminal: flight.terminal || 'Terminal 1'
              }));
              
              console.log(`Backend filtering returned ${filteredFlights.length} flights`);
              
              displayFlights(filteredFlights);
              const resultsCount = document.getElementById('resultsCount');
              if (resultsCount) {
                resultsCount.textContent = `${filteredFlights.length} flights found`;
              }
              return;
            }
          }
          
          console.log('Backend filtering failed, falling back to client-side filtering');
          
        } catch (backendError) {
          console.warn('Backend filtering error, using client-side:', backendError);
        }
        
        // Fallback to client-side filtering
        filteredFlights = currentFlights.filter(flight => {
          // Price filter
          if (flight.price < minPrice || flight.price > maxPrice) return false;
          
          // Time filter
          if (selectedTimes.length > 0) {
            const hour = flight.departureHour;
            const timeMatches = selectedTimes.some(time => {
              if (time === 'morning') return hour >= 6 && hour < 12;
              if (time === 'afternoon') return hour >= 12 && hour < 18;
              if (time === 'evening') return hour >= 18 || hour < 6;
              return false;
            });
            if (!timeMatches) return false;
          }
          
          // Airline filter
          if (selectedAirlines.length > 0 && !selectedAirlines.includes(flight.airline)) {
            return false;
          }
          
          // Stops filter
          if (selectedStops !== 'any') {
            if (selectedStops === 'nonstop' && flight.stops > 0) return false;
            if (selectedStops === '1stop' && flight.stops > 1) return false;
          }
          
          return true;
        });
        
        console.log(`Client-side filtering returned ${filteredFlights.length} flights from ${currentFlights.length} total`);
        
        displayFlights(filteredFlights);
        const resultsCount = document.getElementById('resultsCount');
        if (resultsCount) {
          resultsCount.textContent = `${filteredFlights.length} flights found`;
        }
        
      } catch (error) {
        console.error('Error applying filters:', error);
        // Show original flights if filtering fails
        filteredFlights = [...currentFlights];
        displayFlights(filteredFlights);
      }
    }

    function sortFlights(criteria) {
      if (!filteredFlights.length) return;
      
      filteredFlights.sort((a, b) => {
        switch (criteria) {
          case 'price':
            return a.price - b.price;
          case 'duration':
            return a.duration.localeCompare(b.duration);
          case 'departure':
            return a.departureTime.localeCompare(b.departureTime);
          case 'arrival':
            return a.arrivalTime.localeCompare(b.arrivalTime);
          default:
            return 0;
        }
      });
      
      displayFlights(filteredFlights);
    }

    function populateAirlineFilters() {
      const airlinesFilter = document.getElementById('airlinesFilter');
      if (!airlinesFilter) return;
      
      const airlines = [...new Set(currentFlights.map(f => f.airline))];
      
      airlinesFilter.innerHTML = airlines.map(airline => `
        <label class="airline-option">
          <input type="checkbox" value="${airline}" onchange="applyFilters()">
          <span>${airline}</span>
        </label>
      `).join('');
    }

    // Book flight function with wallet validation
    window.bookFlight = function(flightId) {
      console.log('ðŸ›©ï¸ bookFlight called with flightId:', flightId);
      
      if (typeof flightId === 'undefined') {
        console.error('âŒ Flight ID is undefined!');
        alert('Error: Flight ID is missing!');
        return;
      }
      
      const flight = currentFlights.find(f => f.id === flightId);
      if (!flight) {
        alert('Flight not found. Please refresh and try again.');
        return;
      }

      // Calculate total price
      const totalPassengers = passengerCounts.adults + passengerCounts.children + passengerCounts.infants;
      const totalPrice = flight.price * totalPassengers;
      
      // Get current user data including wallet balance
      const userData = JSON.parse(localStorage.getItem('travelEaseUser')) || { balance: 250.00 };
      const currentBalance = userData.balance || 250.00;
      
      // Check if wallet has sufficient balance
      if (currentBalance < totalPrice) {
        alert(
          `âŒ Insufficient Wallet Balance!\n\n` +
          `Required: $${totalPrice.toFixed(2)}\n` +
          `Available: $${currentBalance.toFixed(2)}\n` +
          `Shortfall: $${(totalPrice - currentBalance).toFixed(2)}\n\n` +
          `Please add money to your wallet to book this flight.`
        );
        return;
      }

      // Show booking confirmation dialog
      const confirmation = confirm(
        `Confirm Flight Booking:\n\n` +
        `Flight: ${flight.flightNumber} - ${flight.airline}\n` +
        `Route: ${flight.from} to ${flight.to}\n` +
        `Departure: ${flight.departureTime}\n` +
        `Arrival: ${flight.arrivalTime}\n` +
        `Passengers: ${totalPassengers} (${passengerCounts.adults} adults, ${passengerCounts.children} children, ${passengerCounts.infants} infants)\n` +
        `Class: ${selectedClass}\n` +
        `Total Price: $${totalPrice}\n\n` +
        `Proceed with booking?`
      );

      if (!confirmation) return;

      // Deduct amount from wallet
      const newBalance = currentBalance - totalPrice;
      userData.balance = newBalance;
      localStorage.setItem('travelEaseUser', JSON.stringify(userData));

      // Create booking record
      const booking = {
        id: Date.now(),
        type: 'flight',
        name: `${flight.airline} ${flight.flightNumber}`,
        location: `${flight.from} â†’ ${flight.to}`,
        flightNumber: flight.flightNumber,
        airline: flight.airline,
        from: flight.from,
        to: flight.to,
        fromFull: flight.fromFull,
        toFull: flight.toFull,
        departureTime: flight.departureTime,
        arrivalTime: flight.arrivalTime,
        duration: flight.duration,
        stops: flight.stopsText,
        passengers: passengerCounts,
        totalPassengers,
        class: selectedClass,
        price: totalPrice,
        pricePerPerson: flight.price,
        totalPrice,
        departDate: document.getElementById('departDate').value,
        returnDate: document.getElementById('returnDate').value || null,
        bookingDate: new Date().toISOString().split('T')[0],
        bookingTime: new Date().toLocaleString(),
        status: 'confirmed'
      };
      
      // Save to upcoming trips
      const upcomingTrips = JSON.parse(localStorage.getItem('upcomingTrips')) || [];
      upcomingTrips.unshift(booking);
      localStorage.setItem('upcomingTrips', JSON.stringify(upcomingTrips));
      
      // Add wallet transaction record
      const transactions = JSON.parse(localStorage.getItem('walletTransactions')) || [];
      transactions.unshift({
        type: 'payment',
        title: `Flight Booking - ${flight.flightNumber} (${flight.from} to ${flight.to})`,
        date: new Date().toLocaleString(),
        method: 'Wallet Balance',
        amount: -totalPrice
      });
      localStorage.setItem('walletTransactions', JSON.stringify(transactions));
      
      // Show success message
      alert(
        `âœ… Flight Booking Confirmed!\n\n` +
        `Flight: ${flight.flightNumber} - ${flight.airline}\n` +
        `Route: ${flight.from} to ${flight.to}\n` +
        `Passengers: ${totalPassengers}\n` +
        `Amount Charged: $${totalPrice}\n` +
        `Remaining Wallet Balance: $${newBalance.toFixed(2)}\n\n` +
        `Booking details have been saved to your dashboard!`
      );
      
      // Trigger dashboard update
      console.log('âœˆï¸ Flight booked, triggering dashboard update...');
      window.dispatchEvent(new CustomEvent('bookingMade', { 
        detail: { type: 'flight', timestamp: Date.now() } 
      }));
      console.log('âœ… Dashboard update triggered successfully!');
    };

    function displayNoFlights() {
      const flightResults = document.getElementById('flightResults');
      flightResults.innerHTML = `
        <div class="no-results">
          <div class="no-results-icon">
            <i class="fas fa-plane-slash"></i>
          </div>
          <h3>No flights found</h3>
          <p>We couldn't find any flights matching your search criteria.</p>
          <div class="suggestions">
            <h4>Try:</h4>
            <ul>
              <li>Adjusting your travel dates</li>
              <li>Checking nearby airports</li>
              <li>Being flexible with your destination</li>
              <li>Removing some filters</li>
            </ul>
          </div>
        </div>
      `;
    }

    function displayErrorMessage() {
      const flightResults = document.getElementById('flightResults');
      flightResults.innerHTML = `
        <div class="error-message">
          <div class="error-icon">
            <i class="fas fa-exclamation-triangle"></i>
          </div>
          <h3>Oops! Something went wrong</h3>
          <p>We're having trouble loading flights right now. Please try again in a moment.</p>
          <button class="retry-btn" onclick="performFlightSearch()">
            <i class="fas fa-redo"></i>
            Try Again
          </button>
        </div>
      `;
    }

    function updateUserDisplays() {
      const userData = JSON.parse(localStorage.getItem('travelEaseUser')) || {
        username: 'User',
        avatar: '../assets/images/img1.png'
      };
      
      const headerUsername = document.getElementById('username');
      const headerAvatar = document.getElementById('userAvatar');
      const sidebarUsername = document.getElementById('sidebarUsername');
      const sidebarAvatar = document.getElementById('sidebarAvatar');
      
      if (headerUsername) headerUsername.textContent = userData.username;
      if (headerAvatar) headerAvatar.src = userData.avatar;
      if (sidebarUsername) sidebarUsername.textContent = userData.username;
      if (sidebarAvatar) sidebarAvatar.src = userData.avatar;
    }
  </script>
</body>
</html>
